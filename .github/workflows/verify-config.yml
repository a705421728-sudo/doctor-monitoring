name: Verify System Configuration

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    # æ¯å‘¨ä¸€æ—©ä¸Š8ç‚¹è‡ªåŠ¨éªŒè¯ä¸€æ¬¡ï¼ˆå¯é€‰ï¼‰
    - cron: '0 8 * * 1'

jobs:
  verify-config:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip

      - name: åˆ›å»ºSMTPæµ‹è¯•è„šæœ¬
        run: |
          cat > test_smtp.py << 'EOF'
          import os
          import smtplib
          import ssl
          
          def test_smtp_connection():
              """åˆ†æ­¥æµ‹è¯•SMTPè¿æ¥ï¼Œæ‰“å°è¯¦ç»†æ—¥å¿—"""
              config = {
                  'server': os.getenv('SMTP_SERVER'),
                  'port': int(os.getenv('SMTP_PORT', '587')),
                  'username': os.getenv('SMTP_USERNAME'),
                  'password': os.getenv('SMTP_PASSWORD'),
              }
              
              print("ğŸ”§ å¼€å§‹SMTPè¿æ¥æµ‹è¯•")
              print(f"   æœåŠ¡å™¨: {config['server']}:{config['port']}")
              print(f"   ç”¨æˆ·å: {config['username']}")
              print("   å¯†ç : " + ("[å·²è®¾ç½®]" if config['password'] else "[æœªè®¾ç½®]"))
              
              try:
                  # 1. æµ‹è¯•æœåŠ¡å™¨å¯è¾¾æ€§ï¼ˆåŸºç¡€è¿æ¥ï¼‰
                  print("\n1. å°è¯•å»ºç«‹åŸºç¡€TCPè¿æ¥...")
                  server = smtplib.SMTP(config['server'], config['port'], timeout=10)
                  print(f"   âœ… TCPè¿æ¥æˆåŠŸ (å“åº”: {server.ehlo()[0]})")
                  
                  # 2. æµ‹è¯•STARTTLSåŠ å¯†
                  print("2. å°è¯•STARTTLSåŠ å¯†...")
                  server.starttls(context=ssl.create_default_context())
                  server.ehlo()
                  print("   âœ… TLSåŠ å¯†æˆåŠŸ")
                  
                  # 3. æµ‹è¯•ç™»å½•è®¤è¯
                  print("3. å°è¯•ç™»å½•è®¤è¯...")
                  server.login(config['username'], config['password'])
                  print("   âœ… ç™»å½•è®¤è¯æˆåŠŸ")
                  
                  # 4. æµ‹è¯•ç®€å•é‚®ä»¶å‘é€
                  print("4. æµ‹è¯•é‚®ä»¶å‘é€...")
                  test_msg = f"From: {config['username']}\nTo: {config['username']}\nSubject: SMTPæµ‹è¯•\n\nè¿™æ˜¯ä¸€å°æ¥è‡ªGitHub Actionsçš„SMTPè¿æ¥æµ‹è¯•é‚®ä»¶ã€‚"
                  server.sendmail(config['username'], config['username'], test_msg)
                  print("   âœ… æµ‹è¯•é‚®ä»¶å‘é€æˆåŠŸ")
                  
                  server.quit()
                  print("\nğŸ‰ æ‰€æœ‰SMTPè¿æ¥æµ‹è¯•é€šè¿‡ï¼")
                  return True
                  
              except Exception as e:
                  print(f"\nâŒ æµ‹è¯•å¤±è´¥äºæ­¥éª¤ {e.__class__.__name__}: {e}")
                  return False
          
          if __name__ == "__main__":
              success = test_smtp_connection()
              exit(0 if success else 1)
          EOF

      - name: ç¬¬ä¸€é˜¶æ®µï¼šSMTPè¿æ¥è¯Šæ–­
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        run: |
          echo "=== SMTPè¿æ¥è¯Šæ–­å¼€å§‹ ==="
          echo "æµ‹è¯•æ—¶é—´: $(date)"
          echo "------------------------"
          
          if [ -z "$SMTP_SERVER" ] || [ -z "$SMTP_USERNAME" ] || [ -z "$SMTP_PASSWORD" ]; then
            echo "âŒ SMTPé…ç½®ä¸å®Œæ•´ï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹GitHub Secrets:"
            echo "   - SMTP_SERVER: $(if [ -z "$SMTP_SERVER" ]; then echo 'æœªè®¾ç½®'; else echo 'å·²è®¾ç½®'; fi)"
            echo "   - SMTP_USERNAME: $(if [ -z "$SMTP_USERNAME" ]; then echo 'æœªè®¾ç½®'; else echo 'å·²è®¾ç½®'; fi)"
            echo "   - SMTP_PASSWORD: $(if [ -z "$SMTP_PASSWORD" ]; then echo 'æœªè®¾ç½®'; else echo 'å·²è®¾ç½®'; fi)"
            echo "   - SMTP_PORT: ${SMTP_PORT:-587 (é»˜è®¤)}"
            exit 1
          fi
          
          python test_smtp.py
          
          echo "------------------------"
          echo "SMTPè¯Šæ–­å®Œæˆ"

      - name: ç¬¬äºŒé˜¶æ®µï¼šå®Œæ•´é…ç½®éªŒè¯
        if: success()  # åªæœ‰SMTPæµ‹è¯•æˆåŠŸåæ‰æ‰§è¡Œ
        env:
          # æ³¨å…¥æ‰€æœ‰å¿…è¦çš„Secrets
          MACKAY_ID_NUMBER: ${{ secrets.MACKAY_ID_NUMBER }}
          MACKAY_BIRTHDAY: ${{ secrets.MACKAY_BIRTHDAY }}
          MACKAY_NOTIFICATION_EMAIL: ${{ secrets.MACKAY_NOTIFICATION_EMAIL }}
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SMTP_SENDER: ${{ secrets.SMTP_SENDER }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          echo "=== å®Œæ•´é…ç½®éªŒè¯å¼€å§‹ ==="
          echo "éªŒè¯æ—¶é—´: $(date)"
          echo "------------------------"
          
          # æ£€æŸ¥æ ¸å¿ƒé…ç½®
          echo "æ£€æŸ¥æ ¸å¿ƒç¯å¢ƒå˜é‡..."
          if [ -z "$MACKAY_ID_NUMBER" ]; then
            echo "âŒ MACKAY_ID_NUMBER æœªè®¾ç½®"
            exit 1
          else
            echo "âœ… MACKAY_ID_NUMBER: å·²è®¾ç½® (é•¿åº¦: ${#MACKAY_ID_NUMBER})"
          fi
          
          if [ -z "$MACKAY_BIRTHDAY" ]; then
            echo "âŒ MACKAY_BIRTHDAY æœªè®¾ç½®"
            exit 1
          else
            echo "âœ… MACKAY_BIRTHDAY: å·²è®¾ç½® (é•¿åº¦: ${#MACKAY_BIRTHDAY})"
          fi
          
          # æ£€æŸ¥é€šçŸ¥é‚®ç®±
          echo -e "\næ£€æŸ¥é€šçŸ¥é‚®ç®±åˆ—è¡¨..."
          if [ -z "$MACKAY_NOTIFICATION_EMAIL" ]; then
            echo "âŒ MACKAY_NOTIFICATION_EMAIL æœªè®¾ç½®"
            exit 1
          else
            # å®‰å…¨åœ°æ˜¾ç¤ºé‚®ç®±æ•°é‡
            EMAIL_COUNT=$(echo "$MACKAY_NOTIFICATION_EMAIL" | tr ',' '\n' | wc -l)
            echo "âœ… æ‰¾åˆ° $EMAIL_COUNT ä¸ªæ”¶ä»¶äººé‚®ç®±"
            
            # æ˜¾ç¤ºç¬¬ä¸€ä¸ªé‚®ç®±ï¼ˆå®‰å…¨å¤„ç†ï¼‰
            FIRST_EMAIL=$(echo "$MACKAY_NOTIFICATION_EMAIL" | cut -d',' -f1)
            if [[ "$FIRST_EMAIL" =~ ^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$ ]]; then
              echo "âœ… ç¬¬ä¸€ä¸ªé‚®ç®±æ ¼å¼æœ‰æ•ˆ: ${FIRST_EMAIL:0:3}***${FIRST_EMAIL: -4}"
            else
              echo "âš ï¸  ç¬¬ä¸€ä¸ªé‚®ç®±æ ¼å¼å¯èƒ½æ— æ•ˆ"
            fi
          fi
          
          echo -e "\næ‰§è¡ŒPythonéªŒè¯è„šæœ¬..."
          python verify_config.py
          
          echo "------------------------"
          echo "å®Œæ•´é…ç½®éªŒè¯å®Œæˆ"

      - name: ä¸Šä¼ éªŒè¯æŠ¥å‘Š
        if: always()  # æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ‰§è¡Œ
        uses: actions/upload-artifact@v4
        with:
          name: verification-report
          path: |
            mackay_register.log
            mackay_state.json
          retention-days: 7
          overwrite: true

      - name: éªŒè¯æ€»ç»“
        run: |
          echo "========================================"
          echo "é…ç½®éªŒè¯å·¥ä½œæµæ‰§è¡Œå®Œæˆ"
          echo "========================================"
          echo "çŠ¶æ€: ${{ job.status }}"
          echo "æ—¶é—´: $(date)"
          echo ""
          echo "ğŸ“‹ éªŒè¯ç»“æœ:"
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… æ‰€æœ‰é…ç½®æ£€æŸ¥é€šè¿‡ï¼"
            echo "âœ… æŒ‚å·ç³»ç»Ÿå·²å°±ç»ª"
            echo "âœ… é‚®ä»¶åŠŸèƒ½æ­£å¸¸"
          else
            echo "âš ï¸  éƒ¨åˆ†é…ç½®éœ€è¦æ£€æŸ¥"
            echo "ğŸ“§ è¯¦ç»†æŠ¥å‘Šè¯·æŸ¥çœ‹å·¥ä½œæµæ—¥å¿—"
          fi
          echo "========================================"
