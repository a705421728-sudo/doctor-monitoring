name: 极简环境变量验证

on:
  workflow_dispatch

jobs:
  verify:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: 验证环境变量
        env:
          # 1. 注入所有需要检查的变量
          MACKAY_ID_NUMBER: ${{ secrets.MACKAY_ID_NUMBER }}
          MACKAY_BIRTHDAY: ${{ secrets.MACKAY_BIRTHDAY }}
          MACKAY_NOTIFICATION_EMAIL: ${{ secrets.MACKAY_NOTIFICATION_EMAIL }}
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          # 注意：这里故意不注入 SMTP_PASSWORD，只在脚本内部使用
          
        run: |
          echo "=== 环境变量读取验证 ==="
          echo "以下变量已从 GitHub Secrets 成功读取："
          echo "----------------------------------------"
          
          # 2. 安全地检查并显示每个变量（不泄露值）
          check_var() {
            local var_name=$1
            local var_value=${!var_name}
            
            if [ -z "$var_value" ]; then
              echo "❌ $var_name: 未设置或为空"
            else
              # 安全显示：前3字符 + *** + 后4字符
              local display_value
              if [ ${#var_value} -gt 7 ]; then
                display_value="${var_value:0:3}***${var_value: -4}"
              else
                display_value="***"
              fi
              echo "✅ $var_name: 已设置 (长度: ${#var_value}) -> $display_value"
            fi
          }
          
          # 3. 检查所有关心的变量
          check_var "MACKAY_ID_NUMBER"
          check_var "MACKAY_BIRTHDAY"
          check_var "SMTP_SERVER"
          check_var "SMTP_PORT"
          check_var "SMTP_USERNAME"
          
          # 4. 特殊处理邮箱列表
          echo ""
          echo "邮箱列表解析："
          if [ -z "$MACKAY_NOTIFICATION_EMAIL" ]; then
            echo "❌ MACKAY_NOTIFICATION_EMAIL: 未设置"
          else
            echo "✅ MACKAY_NOTIFICATION_EMAIL: 已设置"
            # 按逗号分割并统计
            IFS=',' read -ra EMAILS <<< "$MACKAY_NOTIFICATION_EMAIL"
            echo "   解析到 ${#EMAILS[@]} 个邮箱地址"
            for (( i=0; i<${#EMAILS[@]}; i++ )); do
              email=$(echo "${EMAILS[$i]}" | xargs) # 去除首尾空格
              if [[ $email =~ ^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$ ]]; then
                echo "   $((i+1)). ✅ 格式有效: ${email:0:3}***${email: -10}"
              else
                echo "   $((i+1)). ⚠️  格式可疑: $email"
              fi
            done
          fi
          
          echo "----------------------------------------"
          echo "✅ 验证完成：所有变量读取正常。"
          echo ""
          echo "📌 后续步骤："
          echo "   1. 以上显示'✅'表示变量已被正确读取。"
          echo "   2. SMTP连接失败需单独检查服务器、端口和密码。"
